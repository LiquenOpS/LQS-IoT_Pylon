# Pylon South: IoT Agent + MongoDB (IOTA's DB)
# Full-stack: IOTA_CB_HOST=orion (same pylon-net). South-only: IOTA_CB_HOST=North host IP.
# Run: docker compose --env-file config/config.env -f docker-compose.south.yml ...

services:
  iot-agent-json:
    image: fiware/iotagent-json:${IOTA_JSON_VERSION}
    hostname: iot-agent-json
    container_name: fiware-iot-agent-json
    depends_on:
      mongo-iota:
        condition: service_healthy
    networks:
      - pylon_net
    ports:
      - "${IOTA_NORTH_PORT}:${IOTA_NORTH_PORT}"
      - "${IOTA_SOUTH_PORT}:${IOTA_SOUTH_PORT}"
    environment:
      - IOTA_MQTT_DISABLED=${IOTA_MQTT_DISABLED:-true}
      - IOTA_AMQP_DISABLED=${IOTA_AMQP_DISABLED:-true}
      - IOTA_CB_HOST=${IOTA_CB_HOST:-orion}
      - IOTA_CB_PORT=${ORION_PORT}
      - IOTA_NORTH_PORT=${IOTA_NORTH_PORT}
      - IOTA_SOUTH_PORT=${IOTA_SOUTH_PORT}
      - IOTA_LOG_LEVEL=${IOTA_LOG_LEVEL:-DEBUG}
      - IOTA_TIMESTAMP=${IOTA_TIMESTAMP:-true}
      - IOTA_REGISTRY_TYPE=${IOTA_REGISTRY_TYPE:-mongodb}
      - IOTA_MONGO_HOST=${IOTA_MONGO_HOST:-mongo-iota}
      - IOTA_MONGO_PORT=${MONGO_IOTA_PORT}
      - IOTA_MONGO_DB=${MONGO_IOTA_DB:-iotagentjson}
      - IOTA_PROVIDER_URL=http://iot-agent-json:${IOTA_NORTH_PORT}
      - IOTA_HTTP_PORT=${IOTA_SOUTH_PORT}
    healthcheck:
      test: curl --fail -s http://iot-agent-json:${IOTA_NORTH_PORT}/iot/about || exit 1
      interval: 5s

  mongo-iota:
    image: mongo:${MONGO_IOTA_VERSION}
    hostname: mongo-iota
    container_name: db-mongo-iota
    expose:
      - "${MONGO_IOTA_PORT}"
    networks:
      - pylon_net
    volumes:
      - mongo-iota:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 5s
      timeout: 5s
      retries: 3
      start_period: 5s

networks:
  pylon_net:
    name: ${PYLON_NETWORK_NAME:-pylon-net}
    external: true

volumes:
  mongo-iota: ~
