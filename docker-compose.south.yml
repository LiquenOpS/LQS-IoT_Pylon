# Pylon South: IoT Agent (device-facing). Full-stack: IOTA_CB_HOST=orion, IOTA_MONGO_HOST=mongo-db.
# South-only: set IOTA_CB_HOST and IOTA_MONGO_HOST to North host IP.

services:
  iot-agent-json:
    labels:
      org.fiware: 'signage-project'
    image: fiware/iotagent-json:${IOTA_JSON_VERSION}
    hostname: iot-agent-json
    container_name: fiware-iot-agent-json
    networks:
      - pylon_net
    ports:
      - "${IOTA_NORTH_PORT}:${IOTA_NORTH_PORT}"
      - "${IOTA_SOUTH_PORT}:${IOTA_SOUTH_PORT}"
    environment:
      - IOTA_CB_HOST=${IOTA_CB_HOST:-orion}
      - IOTA_CB_PORT=${ORION_PORT}
      - IOTA_NORTH_PORT=${IOTA_NORTH_PORT}
      - IOTA_SOUTH_PORT=${IOTA_SOUTH_PORT}
      - IOTA_LOG_LEVEL=DEBUG
      - IOTA_TIMESTAMP=true
      - IOTA_REGISTRY_TYPE=mongodb
      - IOTA_MONGO_HOST=${IOTA_MONGO_HOST:-mongo-db}
      - IOTA_MONGO_PORT=${MONGO_DB_PORT}
      - IOTA_MONGO_DB=iotagentjson
      - IOTA_PROVIDER_URL=http://iot-agent-json:${IOTA_NORTH_PORT}
      - IOTA_HTTP_PORT=${IOTA_SOUTH_PORT}
    healthcheck:
      test: curl --fail -s http://iot-agent-json:${IOTA_NORTH_PORT}/iot/about || exit 1
      interval: 5s

networks:
  pylon_net:
    name: ${PYLON_NETWORK_NAME:-pylon-net}
    external: true
