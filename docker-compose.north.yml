# Pylon North: Orion + MongoDB (Orion's DB)
# Run: docker compose --env-file config/config.env -f docker-compose.north.yml ...

services:
  orion:
    image: fiware/orion:${ORION_VERSION}
    hostname: orion
    container_name: fiware-orion
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      mongo-orion:
        condition: service_healthy
    networks:
      - pylon_net
    ports:
      - "${ORION_PORT}:${ORION_PORT}"
    command: -dbURI mongodb://mongo-orion:${MONGO_ORION_PORT} -logLevel ${ORION_LOG_LEVEL:-DEBUG} -noCache
    healthcheck:
      test: curl --fail -s http://orion:${ORION_PORT}/version || exit 1
      interval: 5s

  mongo-orion:
    image: mongo:${MONGO_ORION_VERSION}
    hostname: mongo-orion
    container_name: db-mongo-orion
    expose:
      - "${MONGO_ORION_PORT}"
    networks:
      - pylon_net
    volumes:
      - mongo-orion:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 5s
      timeout: 5s
      retries: 3
      start_period: 5s

networks:
  pylon_net:
    name: ${PYLON_NETWORK_NAME:-pylon-net}
    external: true

volumes:
  mongo-orion: ~
